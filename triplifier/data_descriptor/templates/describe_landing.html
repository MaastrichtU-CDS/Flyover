<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<link rel="stylesheet" href="{{ url_for('custom_static', filename='css/bootstrap.min.css') }}">
<link rel="stylesheet" href="{{ url_for('custom_static', filename='css/bootstrap-select.css') }}"/>
<link rel="stylesheet" href="{{ url_for('custom_static', filename='css/all.min.css') }}"/>
<script src="{{ url_for('custom_static', filename='js/jquery.min.js') }}"></script>
<script src="{{ url_for('custom_static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('custom_static', filename='js/bootstrap-select.min.js') }}"></script>

<head>
    <meta charset="UTF-8">
    <title>Flyover | Data submission finalised</title>
</head>

<body>
<!-- Include navigation header -->
{% include 'navigation_header.html' %}

<div class="container">
    <br>
    <h1><i class="fas fa-clipboard-check"></i> Data submission finalised</h1>
    <hr>

    <p>{{ message }}</p>

    <!-- Data Check Section -->
    <div id="dataCheckSection">
        <!-- This will be populated by JavaScript if needed -->
    </div>

    <!-- Global Semantic Map Upload Section -->
    <div id="semanticMapSection" class="mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-project-diagram"></i> Optional: Upload Flyover Semantic Map Template
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    You can optionally upload a Flyover semantic map JSON-LD file to guide the mapping process.<br>
                    This will help provide better semantic annotations and standardised mappings for your data
                    variables. <br><br> You can find an example template <a href="https://github.com/MaastrichtU-CDS/Flyover/blob/main/example_data/mapping_template.jsonld" target="_blank">here</a>.<br>
                    For more information on the Semantic Map, refer to Flyover's README <a href="https://github.com/MaastrichtU-CDS/Flyover/blob/main/README.md" target='_blank'>here</a>.
                </p>

                <div class="alert alert-info"
                     style="font-size: 0.85em; border-left: 4px solid rgba(118,75,162,0.75); background: linear-gradient(135deg, rgba(102,126,234,0.75) 0%, rgba(118,75,162,0.75) 100%); color: white">
                    <i class="fas fa-info-circle"></i>
                    <strong>What is a Global Semantic Map?</strong><br>
                    A global semantic map defines standardised variable definitions, data types, and value mappings
                    that can be consistently applied across different datasets to ensure semantic interoperability.
                </div>

                <form method="POST" action="/upload-semantic-map" enctype="multipart/form-data" id="semanticMapForm">
                    <div class="form-group">
                        <label for="semanticMapPath">Global Semantic Map JSON-LD File:</label>
                        <div class="input-group">
                            <input type="text" id="semanticMapPath" name="semanticMapPath" class="form-control"
                                   placeholder="Select semantic map JSON-LD file..." readonly>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary"
                                        onclick="document.getElementById('semanticMapFile').click();">
                                    <i class="fas fa-folder-open"></i> Browse
                                </button>
                            </div>
                        </div>
                        <input type="file" id="semanticMapFile" name="semanticMapFile" style="display:none;"
                               accept=".jsonld" onchange="updateSemanticMapPath(this)">
                        <small class="form-text text-muted">
                            The JSON-LD file should follow the Flyover semantic mapping schema with @context, schema, and databases sections.
                        </small>
                    </div>

                    <div class="form-group">
                        <button type="submit" id="uploadSemanticMapButton" class="btn btn-success" disabled>
                            <i class="fas fa-upload"></i> Upload Semantic Map
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="skipSemanticMap()">
                            <i class="fas fa-forward"></i> Skip
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="statusMessages"></div>

    <!-- Continue Button -->
    <form method="POST" action="describe_variables" id="continueForm">
        <p>
            <button class="btn btn-primary" type="submit" id="continueButton" disabled>
                <i class="fas fa-play"></i> Click here to describe the data
            </button>
        </p>
    </form>
</div>

<!-- Include footer -->
{% include 'footer.html' %}

<script>
    function updateSemanticMapPath(input) {
        const fullPath = input.value;
        const fileName = fullPath.split('\\').pop();
        $("#semanticMapPath").val(fileName);

        // Enable upload button if file is selected
        $("#uploadSemanticMapButton").prop("disabled", !fileName);
    }

    function skipSemanticMap() {
        // Hide the semantic map section and show success message
        $("#semanticMapSection").hide();
        showStatusMessage("Semantic map upload skipped. You can proceed to describe your data manually.", "info");

        // Enable the continue button
        $("#continueButton").prop("disabled", false);
    }

    function enableContinueButton() {
        $("#continueButton").prop("disabled", false);
    }

    function showStatusMessage(message, type = "success") {
        const alertClass = type === "error" ? "alert-danger" :
            type === "info" ? "alert-info" : "alert-success";

        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <i class="fas fa-${type === "error" ? "exclamation-triangle" :
            type === "info" ? "info-circle" : "check-circle"}"></i>
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        `;

        $("#statusMessages").html(alertHtml);
    }

    $(document).ready(function () {
        // Check if data exists when page loads
        $.ajax({
            url: '/api/check-graph-exists',
            type: 'GET',
            success: function (response) {
                if (!response.exists) {
                    // No data found - show redirect message and button
                    $("#dataCheckSection").html(`
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>No Data Found</strong><br>
                            You cannot proceed with the describe step as no data has been uploaded yet. 
                            Please go back to the Ingest step to upload your data first.
                            <br><br>
                            <a href="/ingest" class="btn btn-primary">
                                <i class="fas fa-arrow-left"></i> Go to Ingest Step
                            </a>
                        </div>
                    `);

                    // Disable the continue button if it exists
                    $("#continueButton").prop("disabled", true);
                }
            },
            error: function () {
                // On error, assume no data and show warning
                $("#dataCheckSection").html(`
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Unable to Verify Data</strong><br>
                        Please ensure you have completed the Ingest step before proceeding.
                        <br><br>
                        <a href="/ingest" class="btn btn-primary">
                            <i class="fas fa-arrow-left"></i> Go to Ingest Step
                        </a>
                    </div>
                `);
            }
        });

        // Handle semantic map form submission
        $("#semanticMapForm").submit(function (e) {
            e.preventDefault();

            if (!$("#semanticMapFile")[0].files.length) {
                showStatusMessage("Please select a semantic map JSON file to upload.", "error");
                return;
            }

            // Create FormData object
            const formData = new FormData();
            formData.append("semanticMapFile", $("#semanticMapFile")[0].files[0]);

            // Show loading state
            $("#uploadSemanticMapButton").prop("disabled", true).html('<i class="fas fa-spinner fa-spin"></i> Uploading...');

            // Submit via AJAX
            $.ajax({
                url: "/upload-semantic-map",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    $("#semanticMapSection").hide();
                    showStatusMessage("Global semantic map uploaded successfully! This will guide the semantic mapping process and help standardise your data annotations.", "success");

                    // Enable the continue button after successful upload
                    enableContinueButton();
                },
                error: function (xhr, status, error) {
                    let errorMessage = "Failed to upload semantic map file.";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    }
                    showStatusMessage(errorMessage, "error");
                    $("#uploadSemanticMapButton").prop("disabled", false).html('<i class="fas fa-upload"></i> Upload Semantic Map');
                }
            });
        });

        // Handle continue form submission
        $("#continueForm").submit(function(e) {
            // Start loading animation for continue button
            startLoadingAnimation('#continueButton');
        });
    });

    // Loading animation functions
    let loadingInterval;

    function startLoadingAnimation(buttonSelector) {
        const button = $(buttonSelector);
        const originalText = button.html();

        // Disable button to prevent multiple submissions
        button.prop('disabled', true);

        // Start with magnifying glass icon
        let isMagnifyingArrow = false;
        button.html('<i class="fas fa-search loading-icon"></i> Retrieving variable names...');

        // Alternate between magnifying glass icons every 1 second with smooth transition
        loadingInterval = setInterval(function() {
            const icon = button.find('.loading-icon');

            // Add fade out effect
            icon.addClass('icon-fade-out');

            setTimeout(function() {
                if (isMagnifyingArrow) {
                    icon.removeClass('fa-magnifying-glass-arrow-right').addClass('fa-search');
                } else {
                    icon.removeClass('fa-search').addClass('fa-magnifying-glass-arrow-right');
                }
                isMagnifyingArrow = !isMagnifyingArrow;

                // Remove fade out and add fade in
                icon.removeClass('icon-fade-out').addClass('icon-fade-in');

                // Clean up fade in class after animation
                setTimeout(function() {
                    icon.removeClass('icon-fade-in');
                }, 300);
            }, 150); // Half of transition duration for smooth crossfade

        }, 1000);

        // Store original text for potential restoration
        button.data('original-text', originalText);
    }

    function stopLoadingAnimation(buttonSelector) {
        const button = $(buttonSelector);

        // Clear the interval
        if (loadingInterval) {
            clearInterval(loadingInterval);
            loadingInterval = null;
        }

        // Restore original button state
        const originalText = button.data('original-text');
        if (originalText) {
            button.html(originalText);
        }
        button.prop('disabled', false);
    }
</script>

<!-- Add some custom CSS -->
<style>
    .card {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .input-group-text {
        background-color: #e9ecef;
        border-color: #ced4da;
    }

    .fas {
        margin-right: 5px;
    }

    .alert {
        margin-top: 15px;
    }

    .alert-info {
        border-left: 4px solid #17a2b8;
    }

    /* Style for disabled button */
    #continueButton:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Smooth loading animation styles */
    .loading-icon {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-block;
    }

    .icon-fade-out {
        opacity: 0;
        transform: scale(0.8) rotate(10deg);
    }

    .icon-fade-in {
        opacity: 1;
        transform: scale(1.1) rotate(-5deg);
        animation: icon-bounce 0.3s ease-out;
    }

    @keyframes icon-bounce {
        0% {
            transform: scale(1.1) rotate(-5deg);
        }
        50% {
            transform: scale(1.2) rotate(0deg);
        }
        100% {
            transform: scale(1) rotate(0deg);
        }
    }

    /* Add a subtle pulse effect to the processing button */
    #continueButton:disabled {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        animation: subtle-pulse 2s infinite;
    }

    @keyframes subtle-pulse {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(108, 117, 125, 0.4);
        }
        50% {
            box-shadow: 0 0 0 4px rgba(108, 117, 125, 0.1);
        }
    }
</style>

<script>
    // Pass Flask variables to JavaScript for navigation header
    window.graph_exists = true; // Data has been ingested at this point
</script>

</body>
</html>

