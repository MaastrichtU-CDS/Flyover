<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<link rel="stylesheet" href="{{ url_for('custom_static', filename='css/bootstrap.min.css') }}">
<link rel="stylesheet" href="{{ url_for('custom_static', filename='css/bootstrap-select.css') }}"/>
<link rel="stylesheet" href="{{ url_for('custom_static', filename='css/all.min.css') }}"/>
<script src="{{ url_for('custom_static', filename='js/jquery.min.js') }}"></script>
<script src="{{ url_for('custom_static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('custom_static', filename='js/bootstrap-select.min.js') }}"></script>

<head>
    <meta charset="UTF-8">
    <title>Flyover | Variable details</title>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .toggle-button {
            cursor: pointer;
            display: inline-block;
            border: none;
            background: none;
            font-size: 1.56rem;
            line-height: 1;
            color: #007bff;
            float: right;
        }

        .item-toggle-button {
            cursor: pointer;
            display: inline-block;
            border: none;
            background: none;
            font-size: 0.91rem;
            line-height: 1;
            color: #007bff;
            float: right;
        }

        .item-toggle-button:before {
            content: 'Show more +';
        }

        .item-toggle-button.open:before {
            content: 'Show less −';
        }

        .toggle-content {
            display: none;
        }

        .toggle-content.active {
            display: block;
        }

        .content {
            width: 100%;
            transition: max-height 0.2s ease-out;
            max-height: 0;
            overflow-y: auto;
        }

        .content.active {
            max-height: 500px;
        }

        .toggle-content {
            width: 100%;
            transition: max-height 0.2s ease-out;
            max-height: 0;
            overflow-y: auto;
        }

        .toggle-content.active {
            max-height: 500px;
        }

        .toggle-button:focus, .item-toggle-button:focus {
            outline: none;
        }

        /* Variable row styling to match describe_variables.html */
        .variable-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .variable-label {
            flex: 0 0 200px;
            font-weight: bold;
            margin-right: 15px;
        }

        .variable-controls {
            flex: 1;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .variable-controls select,
        .variable-controls input {
            flex: 1;
            min-width: 150px;
        }

        /* Missing description styling */
        .missing-description {
            color: #dc3545;
            font-style: italic;
        }

        .missing-description::before {
            content: "⚠️ ";
            margin-right: 5px;
        }

        /* Categorical variable styling */
        .categorical-section {
            margin-top: 20px;
            margin-bottom: 20px;
            margin-left: 20px;
            padding-left: 20px;
            border-left: 3px solid rgba(0, 123, 255, 0.7);
        }

        .category-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 3px;
        }

        .category-label {
            flex: 0 0 180px;
            font-size: 0.9em;
            margin-right: 10px;
        }

        .category-controls {
            flex: 1;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .category-controls .bootstrap-select {
            width: 300px !important;
        }

        /* Smooth loading animation styles */
        .loading-icon {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-block;
        }

        .icon-fade-out {
            opacity: 0;
            transform: scale(0.8) rotate(10deg);
        }

        .icon-fade-in {
            opacity: 1;
            transform: scale(1.1) rotate(-5deg);
            animation: icon-bounce 0.3s ease-out;
        }

        @keyframes icon-bounce {
            0% {
                transform: scale(1.1) rotate(-5deg);
            }
            50% {
                transform: scale(1.2) rotate(0deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        /* Add a subtle pulse effect to the processing button */
        .btn-primary:disabled.processing {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            animation: subtle-pulse 2s infinite;
        }

        @keyframes subtle-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(108, 117, 125, 0.4);
            }
            50% {
                box-shadow: 0 0 0 4px rgba(108, 117, 125, 0.1);
            }
        }

    </style>
</head>

<body>
<!-- Include navigation header -->
{% include 'navigation_header.html' %}

<div class="container">
    <br>
    <h1><i class="fas fa-pencil-ruler"></i> Describe categories and units</h1>
    <hr>
    <p>Please provide more information for the categorical and continuous variables that were defined in the variable
        description page.<br>
    <form class="form-horizontal" method="POST" action="end">
        <hr>
        {% for database, df in dataframes.items() %}
            {% set db_idx = loop.index %}
            <h2 style="display: inline-block;"><i class="fas fa-database"></i> {{ database }}</h2>
            <button class="toggle-button" type="button">
                <span class="toggle-text">Show more</span>
                <svg class="angle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="20" height="20">
                    <path d="M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160z"/>
                </svg>
            </button>
            <div class="content hidden">
                {% for item in df.columns %}
                    {% set item_idx = loop.index %}
                    {% set local_variable_name = item.split('"')[1].split('"')[0].strip() %}
                    {% set global_variable_name = item.split("(")[0].strip().lower().replace(' ', '_') %}
                    {% set item_rows = df.by_column.get(item, []) %}
                    {% set first_value = item_rows[0]['value'] if item_rows else none %}

                    <div class="variable-row">
                        <div class="variable-label">
                            {% if item.startswith('Missing Description') %}
                                <span class="missing-description">{{ item.replace(' (or "', '<br>(or "') | safe }}</span>
                            {% else %}
                                {{ item.replace(' (or "', '<br>(or "') | safe }}
                            {% endif %}
                        </div>

                        <div class="variable-controls">
                            {% if first_value is none %}
                                <!-- Continuous variable -->
                                <input id="{{ database }}_{{ local_variable_name }}" type="text"
                                       name="{{ database }}_{{ local_variable_name }}"
                                       placeholder="Type unit here" class="form-control"></input>
                                <input id="{{ database }}_{{ local_variable_name }}_notation" type="text"
                                       name="{{ database }}_{{ local_variable_name }}_notation_missing_or_unspecified"
                                       placeholder="Type missing value notation here" class="form-control"></input>
                            {% else %}
                                <!-- Categorical variable -->
                                <button class="item-toggle-button" type="button"></button>
                            {% endif %}
                        </div>
                    </div>

                    {% if first_value is not none %}
                        <div class="toggle-content hidden categorical-section">
                            {% for value_dict in item_rows %}
                                {% set item_value = value_dict.get('value') %}
                                {% set value_idx = loop.index %}
                                {% set value = item_value.get('value') if item_value is mapping else item_value %}
                                {% set preselected = preselected_values.get(database + '_' + local_variable_name + '_category_"' + (value|string) + '"') %}

                                <div class="category-item">
                                    <div class="category-label">
                                        {% if item_value['value'] is not none and item_value['value'] != '' %}
                                            {{ item_value['value'] }} (counted: {{ item_value['count'] }})
                                        {% else %}
                                            Empty cells (counted: {{ item_value['count'] }})
                                        {% endif %}
                                    </div>

                                    <div class="category-controls">
                                        <select id="select_{{ db_idx }}_{{ item_idx }}_{{ value_idx }}"
                                                name='{{ database }}_{{ local_variable_name }}_category_"{{ item_value['value'] }}"'
                                                class="selectpicker form-control category-select"
                                                data-comment-id="comment_{{ db_idx }}_{{ item_idx }}_{{ value_idx }}"
                                                data-live-search="true">
                                            {% set item_info = global_variable_info.get(global_variable_name)|default({}) %}
                                            {% if item_info and 'value_mapping' in item_info %}
                                                <option value="">Description</option>
                                                {% for value in item_info.get('value_mapping').get('terms').keys() %}
                                                    <option {% if preselected == value.title().replace('_', ' ') %}selected{% endif %}>
                                                        {{ value.title().replace('_', ' ') }}
                                                    </option>
                                                {% endfor %}
                                                <option value="Other">Other</option>
                                            {% else %}
                                                <option value="">Description</option>
                                                <option value="Yes">Yes</option>
                                                <option value="No">No</option>
                                                <option value="Male">Male sex</option>
                                                <option value="Female">Female sex</option>
                                                <option value="Primary Education">Primary education</option>
                                                <option value="Secondary Education">Secondary education</option>
                                                <option value="Tertiary Education">Tertiary education</option>
                                                <option value="Missing">Missing value</option>
                                                <option value="Other">Other</option>
                                            {% endif %}
                                        </select>

                                        <input class="form-control" type="text"
                                               id="comment_{{ db_idx }}_{{ item_idx }}_{{ value_idx }}"
                                               name='comment_{{ database }}_{{ local_variable_name }}_category_"{{ item_value['value'] }}"'
                                               placeholder="If other, please specify"
                                               disabled='disabled'
                                               style="width: 200px;"/>
                                    </div>
                                </div>

                                <input type="hidden"
                                       id="count_{{ db_idx }}_{{ item_idx }}_{{ value_idx }}"
                                       name='count_{{ database }}_{{ local_variable_name }}_category_"{{ item_value['value'] }}"'
                                       value="{{ item_value['count'] }}"/>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <hr>
        {% endfor %}

        <p>
            <button type="submit" id="submitBtn" class="btn btn-primary">
                <i class="fas fa-play"></i> Submit
            </button>
        </p>

        <!-- Reference Guide Section -->
        <div class="mt-4">
            <div class="alert alert-info py-2"
                 style="font-size: 0.85em; border-left: 4px solid #764ba2; background: linear-gradient(135deg, rgba(102,126,234,0.75) 0%, rgba(118,75,162,0.75) 100%); color: white">
                <i class="fas fa-info-circle"></i>
                <strong>Reference Guide</strong><br>
                <div class="mt-1 ms-4">
                    <!-- Data Types Section -->
                    <strong style="font-size: 0.9em;">Data Types:</strong>
                    <div class="row g-1 mt-1">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-tags me-2 ref-guide-icon"
                                   style="margin-right: 5px; margin-top: 5px; align-self: flex-start;"></i>
                                <span>
                                <strong style="font-size: 0.9em;">Categorical</strong>
                                <span class="mb-1" style="font-size: 0.85em;"> - Please select the categories that best describe the listed values. <br>
        If none of the available categories accurately represent a given value,
        please select 'Other' and specify what the value represents in the text box.
                                </span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-chart-line me-2 ref-guide-icon"
                                   style="margin-right: 5px; margin-top: 5px; align-self: flex-start;"></i>
                                <span>
                                <strong style="font-size: 0.9em;">Continuous</strong>
                                <span class="mb-1" style="font-size: 0.85em;"> - For each continuous variable, please specify the unit and missing value notation in the text fields.</span>
                            </span>
                            </div>
                        </div>
                    </div>
                    <!-- Additional Instructions Section -->
                    <div class="mt-3">
                        <hr>
                        <strong style="font-size: 0.9em;">Additional Information:</strong>
                        <div class="mt-1">
                            <p class="mb-1">
                                <i class="fas fa-exclamation-triangle"
                                   style="margin-right: 5px; align-self: flex-start;"></i><i><b>Please do note that
                                variables that
                                are by definition standardised
                                <u>do not have to be described</u>.</b><br>
                                Examples thereof are variables like CIM/CIE/ICD-10 disease classifications,
                                or EORTC-QLQ-C30 and EuroQoL EQ5D responses.</i></p>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <script>
        // Loading animation functions
        let loadingInterval;

        function startLoadingAnimation(buttonSelector) {
            const button = $(buttonSelector);
            const originalText = button.html();

            // Disable button and add processing class
            button.prop('disabled', true).addClass('processing');

            // Start with edit icon
            let isPen = false;
            button.html('<i class="fas fa-edit loading-icon"></i> Processing descriptions...');

            // Alternate between edit and pen every 1 second with smooth transition
            loadingInterval = setInterval(function() {
                const icon = button.find('.loading-icon');

                // Add fade out effect
                icon.addClass('icon-fade-out');

                setTimeout(function() {
                    if (isPen) {
                        icon.removeClass('fa-pen').addClass('fa-edit');
                    } else {
                        icon.removeClass('fa-edit').addClass('fa-pen');
                    }
                    isPen = !isPen;

                    // Remove fade out and add fade in
                    icon.removeClass('icon-fade-out').addClass('icon-fade-in');

                    // Clean up fade in class after animation
                    setTimeout(function() {
                        icon.removeClass('icon-fade-in');
                    }, 300);
                }, 150); // Half of transition duration for smooth crossfade

            }, 1000);

            // Store original text for potential restoration
            button.data('original-text', originalText);
        }

        function stopLoadingAnimation(buttonSelector) {
            const button = $(buttonSelector);

            // Clear the interval
            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }

            // Restore original button state
            const originalText = button.data('original-text');
            if (originalText) {
                button.html(originalText);
            }
            button.prop('disabled', false).removeClass('processing');
        }

        $(document).ready(function () {
            $('.toggle-button').click(function () {
                var textElement = $(this).find('.toggle-text');
                var svgElement = $(this).find('.angle-icon path');
                if (textElement.text() === 'Show more') {
                    textElement.text('Show less');
                    svgElement.attr('d', 'M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z'); // SVG path for angle down
                } else {
                    textElement.text('Show more');
                    svgElement.attr('d', 'M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160z'); // SVG path for angle up
                }
                $(this).toggleClass('open');
                $(this).next('.content').toggleClass('active');
            });

            $('.item-toggle-button').click(function () {
                $(this).toggleClass('open');
                // Find the next .toggle-content after the current variable-row
                $(this).closest('.variable-row').next('.toggle-content').toggleClass('active');
            });

            // Handle form submission
            $('form').submit(function(e) {
                // Start loading animation for submit button
                startLoadingAnimation('#submitBtn');
            });

            $(".selectpicker").on('show.bs.select', function (e) {
                var dropdownMenu = $(this).parent().find('.dropdown-menu');
                var toggleContent = $(this).closest('.toggle-content');
                var newHeight = Math.max(toggleContent.height(), dropdownMenu.height());
                toggleContent.height(newHeight + 53);
                toggleContent.css('overflow-y', 'hidden');
            });

            $(".selectpicker").on('hide.bs.select', function (e) {
                var toggleContent = $(this).closest('.toggle-content');
                toggleContent.height('auto');
                toggleContent.css('overflow-y', 'auto');
            });

            // Handle category select change to enable/disable comment field
            // Uses class-based selection and data attributes to avoid issues with special characters in IDs
            $('.category-select').on('change', function () {
                var commentId = $(this).data('comment-id');
                var commentInput = $('[id="' + commentId + '"]');
                if ($(this).val() === "Other") {
                    commentInput.removeAttr("disabled");
                } else {
                    commentInput.attr("disabled", "disabled");
                }
            });
        });
    </script>

    <script>
        // Pass Flask variables to JavaScript for navigation header
        window.graph_exists = true; // Data exists in describe step
    </script>

</div>
<!-- Include footer -->
{% include 'footer.html' %}
</body>
</html>

