<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>Flyover | Annotation Review</title>
    <link rel="stylesheet" href="{{ url_for('custom_static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('custom_static', filename='css/all.min.css') }}"/>
    <script src="{{ url_for('custom_static', filename='js/jquery.min.js') }}"></script>
    <script src="{{ url_for('custom_static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .toggle-button {
            cursor: pointer;
            display: inline-block;
            border: none;
            background: none;
            font-size: 1.56rem;
            line-height: 1;
            color: #007bff;
            float: right;
        }

        .content {
            width: 100%;
            transition: max-height 0.5s ease-out;
            max-height: 0;
            overflow-y: auto;
        }

        .content.active {
            max-height: 1000px;
        }

        .toggle-button:focus {
            outline: none;
        }

        .variable-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .variable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .variable-name {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
        }

        .variable-details {
            margin-left: 15px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 6px;
        }

        .detail-label {
            font-weight: bold;
            width: 140px;
            color: #6c757d;
            font-size: 0.9em;
        }

        .detail-value {
            color: #495057;
            font-size: 0.9em;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
        }

        .status-annotated {
            background-color: #d4edda;
            color: #155724;
        }

        .status-unannotated {
            background-color: #f8d7da;
            color: #721c24;
        }

        .value-mapping-section {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 8px;
            margin-top: 8px;
        }

        .value-mapping-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            padding: 4px 8px;
            background-color: white;
            border-radius: 3px;
            border: 1px solid #dee2e6;
            font-size: 0.85em;
        }

        .annotation-actions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .database-summary {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .unannotated-section {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .unannotated-section ul {
            margin-bottom: 0;
            padding-left: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Knowledge Graph Styles */
        .knowledge-graph-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #dee2e6;
        }

        .graph-toggle-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .graph-filter-btn {
            padding: 5px 12px;
            border: 1px solid #007bff;
            background-color: #007bff;
            color: white;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .graph-filter-btn:hover {
            background-color: #0056b3;
        }

        .graph-filter-btn.inactive {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .knowledge-graph-svg {
            width: 100%;
            height: 300px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: white;
        }

        /* Variable Status Color Coding */
        .variable-complete {
            border-left: 4px solid #28a745;
        }

        .variable-incomplete {
            border-left: 4px solid #dc3545;
        }

        .variable-partial {
            border-left: 4px solid #ffc107;
        }

        /* Graph Node Styles */
        .graph-node-complete {
            fill: #1f77b4;
            stroke: #155a8a;
            stroke-width: 2;
        }

        .graph-node-incomplete {
            fill: #ff7f0e;
            stroke: #cc5a00;
            stroke-width: 2;
        }

        .graph-node-intermediate {
            fill: #2ca02c;
            stroke: #20751f;
            stroke-width: 2;
        }

        .graph-node-value {
            fill: #d62728;
            stroke: #a01d1e;
            stroke-width: 1;
        }

        .graph-node-entity {
            fill: #9467bd;
            stroke: #6a4c93;
            stroke-width: 3;
        }

        .graph-link {
            stroke: #6c757d;
            stroke-width: 2;
            fill: none;
        }

        .graph-label {
            font-family: Arial, sans-serif;
            font-size: 11px;
            text-anchor: middle;
            dominant-baseline: middle;
            fill: #333;
            pointer-events: none;
        }

        .graph-label-predicate {
            font-size: 9px;
            fill: #666;
            font-style: italic;
        }

        /* Enhanced Button Styles */
        .progress-button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .progress-button .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, rgba(40, 167, 69, 0.3) 0%, rgba(40, 167, 69, 0.6) 100%);
            width: 0%;
            transition: width 0.5s ease;
            z-index: 1;
        }

        .progress-button .button-text {
            position: relative;
            z-index: 2;
        }

        .progress-button.processing {
            background: linear-gradient(45deg, #007bff, #0056b3, #007bff);
            background-size: 200% 200%;
            animation: gradient-shift 2s ease-in-out infinite;
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* View Toggle Styles */
        .view-toggle {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px;
            z-index: 1000;
        }

        .view-toggle button {
            display: block;
            width: 100%;
            margin-bottom: 5px;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-toggle button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .view-toggle button:hover {
            background-color: #f8f9fa;
        }

        .view-toggle button.active:hover {
            background-color: #0056b3;
        }

        /* Graph View Styles */
        .graph-view .variable-details {
            display: none;
        }

        .traditional-view .knowledge-graph-container {
            display: none;
        }

        /* Tooltip Styles */
        .tooltip {
            position: absolute;
            padding: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
    </style>
</head>

<body>
<!-- View Toggle Controls -->
<div class="view-toggle">
    <button id="graphViewBtn" class="active" onclick="switchView('graph')">
        <i class="fas fa-project-diagram"></i> Graph View
    </button>
    <button id="traditionalViewBtn" onclick="switchView('traditional')">
        <i class="fas fa-list"></i> Traditional View
    </button>
</div>

<!-- Global Filter Controls -->
<div class="container">
    <br>
    <h1><i class="fas fa-search"></i> Review Annotation Data</h1>
    <hr>

    <p style="line-height: 1.5; margin: 0;">Please review the variable mappings below before proceeding with the
        annotation process.<br>
        If information is missing or incorrect, you can adjust the local definitions through the describe data pages.
    </p>

    <div class="graph-toggle-controls" id="globalFilters" style="margin-top: 15px;">
        <button class="graph-filter-btn" data-filter="complete" onclick="toggleFilter('complete')">
            <i class="fas fa-check-circle"></i> Described Variables
        </button>
        <button class="graph-filter-btn" data-filter="incomplete" onclick="toggleFilter('incomplete')">
            <i class="fas fa-exclamation-triangle"></i> Undescribed Variables
        </button>
        <button class="graph-filter-btn" data-filter="values" onclick="toggleFilter('values')">
            <i class="fas fa-tags"></i> Value Mappings
        </button>
        <button class="graph-filter-btn" onclick="resetAllGraphs()">
            <i class="fas fa-sync-alt"></i> Reset All
        </button>
    </div>

    {% if annotation_data %}
        <form class="form-horizontal">
            <hr>
            {% for database, variables in annotation_data.items() %}
                <h2 style="display: inline-block;"><i class="fas fa-database"></i> {{ database }}</h2>
                <button class="toggle-button" type="button">
                    <span class="toggle-text">Show more</span>
                    <svg class="angle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="20"
                         height="20">
                        <path d="M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160z"/>
                    </svg>
                </button>
                <div class="content hidden">
                    <div class="database-summary">
                        <strong>Database Summary:</strong>
                        {{ variables|length }} variable(s) ready for annotation
                    </div>

                    {% for var_name, var_info in variables.items() %}
                        {% set var_complete = var_info.local_definition and var_info.data_type %}
                        {% set var_partial = var_info.local_definition or var_info.data_type %}
                        <div class="variable-card {% if var_complete %}variable-complete{% elif var_partial %}variable-partial{% else %}variable-incomplete{% endif %}" 
                             data-variable="{{ var_name }}" data-database="{{ database }}">
                            <div class="variable-header">
                                <div class="variable-name">{{ var_name }}</div>
                                <div class="status-badge {% if var_info.local_definition %}status-annotated{% else %}status-unannotated{% endif %}">
                                    {% if var_info.local_definition %}
                                        <i class="fas fa-check-circle"></i> Described
                                    {% else %}
                                        <i class="fas fa-exclamation-triangle"></i> Undescribed
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Knowledge Graph Container -->
                            <div class="knowledge-graph-container">
                                <h6><i class="fas fa-project-diagram"></i> Knowledge Graph Representation</h6>
                                <svg class="knowledge-graph-svg" id="graph-{{ database }}-{{ var_name }}"></svg>
                            </div>

                            <!-- Traditional Variable Details -->
                            <div class="variable-details">
                                <div class="detail-row">
                                    <div class="detail-label">Local Definition:</div>
                                    <div class="detail-value">
                                        {{ var_info.local_definition if var_info.local_definition else 'Not specified' }}
                                    </div>
                                </div>

                                <div class="detail-row">
                                    <div class="detail-label">Predicate:</div>
                                    <div class="detail-value"><code>{{ var_info.predicate }}</code></div>
                                </div>

                                <div class="detail-row">
                                    <div class="detail-label">Class:</div>
                                    <div class="detail-value"><code>{{ var_info.class }}</code></div>
                                </div>

                                {% if var_info.data_type %}
                                    <div class="detail-row">
                                        <div class="detail-label">Data Type:</div>
                                        <div class="detail-value">{{ var_info.data_type }}</div>
                                    </div>
                                {% endif %}

                                {% if var_info.value_mapping and var_info.value_mapping.terms %}
                                    <div class="detail-row">
                                        <div class="detail-label">Value Mapping:</div>
                                        <div class="detail-value">
                                            <div class="value-mapping-section">
                                                {% for term, term_info in var_info.value_mapping.terms.items() %}
                                                    {% if term_info.local_term %}
                                                        <div class="value-mapping-item">
                                                            <span><strong>{{ term.replace('_', ' ').title() }}</strong></span>
                                                            <span>{{ term_info.local_term }}</span>
                                                            <span><code>{{ term_info.target_class }}</code></span>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Store variable data for JavaScript -->
                            <script type="application/json" class="variable-data">
                                {{ var_info | tojson }}
                            </script>
                        </div>
                    {% endfor %}
                </div>
                <hr>
            {% endfor %}
        </form>

{#        {% if unannotated_variables %}#}
{#            <div class="unannotated-section">#}
{#                <h4><i class="fas fa-exclamation-triangle"></i> Undescribed Variables</h4>#}
{#                <p>The following variables were not described and will be skipped:</p>#}
{#                <ul>#}
{#                    {% for var in unannotated_variables %}#}
{#                        <li>{{ var }}</li>#}
{#                    {% endfor %}#}
{#                </ul>#}
{#            </div>#}
{#            <br>#}
{#        {% endif %}#}

        <button id="startAnnotation" class="btn btn-primary progress-button" onclick="startAnnotationProcess()">
            <div class="progress-bar"></div>
            <span class="button-text">
                <i class="fas fa-play"></i> Start Annotation Process
            </span>
        </button>
        <a href="/download" class="btn btn-light">
            <i class="fas fa-arrow-left"></i> Back to Downloads
        </a>
        <br>
        <div class="mt-4">
            <div class="alert alert-info py-2" style="font-size: 0.85em; border-left: 4px solid #17a2b8;">
                <i class="fas fa-info-circle"></i>
                <strong>Annotating your data</strong><br>
                <div class="mt-1 ms-4">
                    <div class="mt-1">
                        <p class="mb-1">
                            Please consider that annotation data can always be adapted without having to re-upload your
                            data.<br>
                            You can do this by removing the annotation graph in the GraphDB user interface and simply
                            redoing the annotation process.
                        </p>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>No annotation data found</strong><br>
            Please ensure you have uploaded a semantic map and described your data before proceeding.
            <br><br>
            <a href="/" class="btn btn-light">Return to Home</a>
        </div>
    {% endif %}
</div>

<script>
    // Global variables for filtering and view management
    let currentView = 'graph';
    let activeFilters = {
        complete: true,
        incomplete: true,
        values: true
    };

    // Toggle functionality for database sections (matching categories.html pattern)
    $(document).ready(function () {
        $('.toggle-button').click(function () {
            var textElement = $(this).find('.toggle-text');
            var svgElement = $(this).find('.angle-icon path');
            if (textElement.text() === 'Show more') {
                textElement.text('Show less');
                svgElement.attr('d', 'M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160-160z');
            } else {
                textElement.text('Show more');
                svgElement.attr('d', 'M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160z');
            }
            $(this).toggleClass('open');
            $(this).next('.content').toggleClass('active');
            
            // Render graphs when content becomes visible
            if ($(this).next('.content').hasClass('active')) {
                setTimeout(() => {
                    renderAllGraphsInSection($(this).next('.content'));
                }, 100);
            }
        });
        
        // Initialize graphs for initially visible sections
        setTimeout(() => {
            renderAllGraphs();
        }, 100);
    });

    // View switching functionality
    function switchView(view) {
        currentView = view;
        document.body.className = view + '-view';
        
        // Update button states
        document.getElementById('graphViewBtn').classList.toggle('active', view === 'graph');
        document.getElementById('traditionalViewBtn').classList.toggle('active', view === 'traditional');
        
        // Re-render graphs if switching to graph view
        if (view === 'graph') {
            setTimeout(() => {
                renderAllGraphs();
            }, 100);
        }
    }

    // Filter toggle functionality
    function toggleFilter(filterType) {
        activeFilters[filterType] = !activeFilters[filterType];
        
        // Update button appearance
        const btn = document.querySelector(`[data-filter="${filterType}"]`);
        btn.classList.toggle('inactive', !activeFilters[filterType]);
        
        // Re-render all graphs with new filters
        renderAllGraphs();
    }

    // Reset all graphs
    function resetAllGraphs() {
        // Reset all filters to true
        Object.keys(activeFilters).forEach(key => {
            activeFilters[key] = true;
            const btn = document.querySelector(`[data-filter="${key}"]`);
            if (btn) btn.classList.remove('inactive');
        });
        
        // Re-render all graphs
        renderAllGraphs();
    }

    // Render all graphs in visible sections
    function renderAllGraphs() {
        document.querySelectorAll('.content.active .variable-card').forEach(card => {
            const database = card.dataset.database;
            const variable = card.dataset.variable;
            renderKnowledgeGraph(database, variable);
        });
    }

    // Render graphs in a specific section
    function renderAllGraphsInSection(section) {
        section.find('.variable-card').each(function() {
            const database = $(this).data('database');
            const variable = $(this).data('variable');
            renderKnowledgeGraph(database, variable);
        });
    }

    // Main function to render knowledge graph for a variable
    function renderKnowledgeGraph(database, variableName) {
        const svgId = `#graph-${database}-${variableName}`;
        const variableCard = document.querySelector(`[data-variable="${variableName}"][data-database="${database}"]`);
        
        if (!variableCard) return;
        
        const variableDataElement = variableCard.querySelector('.variable-data');
        if (!variableDataElement) return;
        
        let variableData;
        try {
            variableData = JSON.parse(variableDataElement.textContent);
        } catch (e) {
            console.error('Error parsing variable data:', e);
            return;
        }

        // Clear existing graph
        d3.select(svgId).selectAll("*").remove();

        const svg = d3.select(svgId);
        const width = parseInt(svg.style("width"));
        const height = parseInt(svg.style("height"));

        // Create graph data structure
        const graphData = createGraphData(variableName, variableData, database);
        
        // Apply filters
        const filteredData = applyFilters(graphData);
        
        if (filteredData.nodes.length === 0) {
            // Show message when no nodes pass filters
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height / 2)
                .attr("text-anchor", "middle")
                .attr("class", "graph-label")
                .style("font-size", "14px")
                .style("fill", "#6c757d")
                .text("No elements match current filters");
            return;
        }

        // Set Entity node fixed position at center
        filteredData.nodes.forEach(node => {
            if (node.type === 'entity') {
                node.fx = width / 2;
                node.fy = height / 2;
            }
        });

        // Create force simulation with Entity-centered layout
        const simulation = d3.forceSimulation(filteredData.nodes)
            .force("link", d3.forceLink(filteredData.links).id(d => d.id)
                .distance(d => {
                    // Different distances for different connection types
                    if (d.source.type === 'entity' || d.target.type === 'entity') return 120; // Entity to variables
                    if (d.source.type === 'intermediate' || d.target.type === 'intermediate') return 90; // Schema connections
                    return 70; // Value mappings
                }))
            .force("charge", d3.forceManyBody().strength(d => {
                // Different forces for different node types
                if (d.type === 'entity') return -800; // Strong repulsion for Entity
                if (d.type === 'complete' || d.type === 'incomplete') return -400; // Medium for variables
                return -200; // Weaker for schema and values
            }))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(d => {
                // Different collision radii for different node types
                if (d.type === 'entity') return 35;
                if (d.type === 'complete' || d.type === 'incomplete') return 25;
                if (d.type === 'intermediate') return 20;
                return 15; // Values
            }));

        // Create tooltip
        const tooltip = createTooltip();

        // Draw links
        const link = svg.append("g")
            .selectAll("path")
            .data(filteredData.links)
            .join("path")
            .attr("class", "graph-link")
            .attr("marker-end", "url(#arrowhead)");

        // Add arrowhead marker
        svg.append("defs").append("marker")
            .attr("id", "arrowhead")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 25)
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("class", "graph-link");

        // Draw nodes
        const node = svg.append("g")
            .selectAll("circle")
            .data(filteredData.nodes)
            .join("circle")
            .attr("r", d => {
                // Different sizes for different node types
                if (d.type === 'entity') return 30;
                if (d.type === 'complete' || d.type === 'incomplete') return 20;
                if (d.type === 'intermediate') return 15;
                return 12; // Values
            })
            .attr("class", d => `graph-node-${d.type}`)
            .call(d3.drag()
                .filter(d => d.type !== 'entity') // Prevent dragging Entity node
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended))
            .on("mouseover", function(event, d) {
                showTooltip(event, d, tooltip);
            })
            .on("mouseout", function() {
                hideTooltip(tooltip);
            });

        // Add labels
        const label = svg.append("g")
            .selectAll("text")
            .data(filteredData.nodes)
            .join("text")
            .attr("class", "graph-label")
            .style("font-size", d => d.type === 'value' ? "10px" : "11px")
            .text(d => d.label);

        // Add predicate labels on links
        const linkLabel = svg.append("g")
            .selectAll("text")
            .data(filteredData.links)
            .join("text")
            .attr("class", "graph-label-predicate")
            .text(d => d.predicateLabel);

        // Update positions on simulation tick
        simulation.on("tick", () => {
            link.attr("d", d => {
                const dx = d.target.x - d.source.x;
                const dy = d.target.y - d.source.y;
                const dr = Math.sqrt(dx * dx + dy * dy);
                return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
            });

            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);

            label
                .attr("x", d => d.x)
                .attr("y", d => d.y + (d.type === 'variable' ? 5 : 3));

            linkLabel
                .attr("x", d => (d.source.x + d.target.x) / 2)
                .attr("y", d => (d.source.y + d.target.y) / 2 - 5);
        });

        // Drag functions
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }
    }

    // Create graph data structure from variable information
    function createGraphData(variableName, variableData, database) {
        const nodes = [];
        const links = [];
        let nodeId = 0;

        // Create central Entity node
        const entityNodeId = nodeId++;
        nodes.push({
            id: entityNodeId,
            label: 'Entity',
            type: 'entity',
            fullData: { description: 'Central entity representing the study subject' },
            description: `Entity: Central node representing the study subject\nDatabase: ${database}`,
            fx: null, // Will be set to center later
            fy: null  // Will be set to center later
        });

        // Create variable node
        const variableNodeId = nodeId++;
        const isComplete = variableData.local_definition && variableData.data_type;
        nodes.push({
            id: variableNodeId,
            label: variableData.local_definition || variableName,
            type: isComplete ? 'complete' : 'incomplete',
            fullData: variableData,
            description: `Variable: ${variableName}\nClass: ${variableData.class}\nPredicate: ${variableData.predicate}`
        });

        // Connect variable to Entity using its predicate
        links.push({
            source: entityNodeId,
            target: variableNodeId,
            predicate: variableData.predicate,
            predicateLabel: getPredicateLabel(variableData.predicate)
        });

        let lastSchemaNodeId = variableNodeId;

        // Process schema reconstruction for hierarchical relationships
        if (variableData.schema_reconstruction && Array.isArray(variableData.schema_reconstruction)) {
            variableData.schema_reconstruction.forEach(item => {
                if (item.placement === 'after') {
                    // Add node after variable (like EHR)
                    const afterNodeId = nodeId++;
                    nodes.push({
                        id: afterNodeId,
                        label: item.aesthetic_label || item.class_label || item.class,
                        type: 'intermediate',
                        fullData: item,
                        description: `Class: ${item.class}\nPredicate: ${item.predicate}`
                    });
                    
                    links.push({
                        source: lastSchemaNodeId,
                        target: afterNodeId,
                        predicate: item.predicate,
                        predicateLabel: getPredicateLabel(item.predicate)
                    });
                    
                    lastSchemaNodeId = afterNodeId;
                } else {
                    // Add node before variable (like Demographic) - connects to variable
                    const beforeNodeId = nodeId++;
                    nodes.push({
                        id: beforeNodeId,
                        label: item.aesthetic_label || item.class_label || item.class,
                        type: 'intermediate',
                        fullData: item,
                        description: `Class: ${item.class}\nPredicate: ${item.predicate}`
                    });
                    
                    links.push({
                        source: beforeNodeId,
                        target: variableNodeId,
                        predicate: item.predicate,
                        predicateLabel: getPredicateLabel(item.predicate)
                    });
                }
            });
        }

        // Add value mappings as branches from the variable node
        if (variableData.value_mapping && variableData.value_mapping.terms) {
            Object.entries(variableData.value_mapping.terms).forEach(([termKey, termData]) => {
                if (termData.local_term) { // Only show mappings with local terms
                    const valueNodeId = nodeId++;
                    nodes.push({
                        id: valueNodeId,
                        label: termData.local_term,
                        type: 'value',
                        fullData: termData,
                        description: `Value: ${termData.local_term}\nMaps to: ${termData.target_class}`
                    });
                    
                    links.push({
                        source: variableNodeId,
                        target: valueNodeId,
                        predicate: 'hasValue',
                        predicateLabel: 'has value'
                    });
                }
            });
        }

        return { nodes, links };
    }

    // Apply active filters to graph data
    function applyFilters(graphData) {
        const filteredNodes = graphData.nodes.filter(node => {
            switch (node.type) {
                case 'complete':
                case 'incomplete':
                    return activeFilters.complete && node.type === 'complete' || 
                           activeFilters.incomplete && node.type === 'incomplete';
                case 'intermediate':
                    return true; // Always show schema hierarchy nodes for context
                case 'entity':
                    return true; // Always show entity node
                case 'value':
                    return activeFilters.values;
                default:
                    return true;
            }
        });

        const nodeIds = new Set(filteredNodes.map(n => n.id));
        const filteredLinks = graphData.links.filter(link => 
            nodeIds.has(link.source.id || link.source) && 
            nodeIds.has(link.target.id || link.target)
        );

        return {
            nodes: filteredNodes,
            links: filteredLinks
        };
    }

    // Create tooltip element
    function createTooltip() {
        return d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
    }

    // Show tooltip
    function showTooltip(event, data, tooltip) {
        tooltip.transition()
            .duration(200)
            .style("opacity", .9);
        tooltip.html(data.description)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px");
    }

    // Hide tooltip
    function hideTooltip(tooltip) {
        tooltip.transition()
            .duration(500)
            .style("opacity", 0)
            .remove();
    }

    // Get human-readable predicate label
    function getPredicateLabel(predicate) {
        const predicateMap = {
            // SIO predicates
            'sio:SIO_000008': 'has attribute',
            'sio:SIO_000221': 'has unit',
            'sio:SIO_000235': 'is about',
            'sio:SIO_000253': 'is part of',
            'sio:SIO_000300': 'is described by',
            'sio:SIO_000332': 'is input in',
            'sio:SIO_000628': 'refers to',
            'sio:SIO_000673': 'has identifier',
            'sio:SIO_000747': 'has value',
            
            // ROO predicates
            'roo:P100029': 'has finding',
            'roo:P100018': 'consists of',
            'roo:P100042': 'is member of',
            
            // NCIT predicates
            'ncit:C25364': 'has property',
            'ncit:C93415': 'maps to',
            
            // Schema.org predicates
            'schema:name': 'name',
            'schema:description': 'description',
            'schema:value': 'value',
            'schema:additionalType': 'additional type'
        };
        
        if (predicateMap[predicate]) {
            return predicateMap[predicate];
        }
        
        // Extract local part from namespaced predicates
        if (predicate && predicate.includes(':')) {
            return predicate.split(':')[1];
        }
        
        return predicate || 'related to';
    }

    // Enhanced annotation process with progress indication
    function startAnnotationProcess() {
        const button = document.getElementById('startAnnotation');
        const progressBar = button.querySelector('.progress-bar');
        const buttonText = button.querySelector('.button-text');
        
        button.disabled = true;
        button.classList.add('processing');
        buttonText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Initializing...';
        
        // Simulate progressive stages
        const stages = [
            { progress: 10, text: 'Validating semantic map...' },
            { progress: 25, text: 'Processing variables...' },
            { progress: 50, text: 'Building annotations...' },
            { progress: 75, text: 'Uploading to GraphDB...' },
            { progress: 90, text: 'Finalizing...' }
        ];
        
        let currentStage = 0;
        
        const updateProgress = () => {
            if (currentStage < stages.length) {
                const stage = stages[currentStage];
                progressBar.style.width = stage.progress + '%';
                buttonText.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${stage.text}`;
                currentStage++;
                setTimeout(updateProgress, 1000); // Update every second
            } else {
                // Start actual annotation process
                performAnnotation();
            }
        };
        
        setTimeout(updateProgress, 500);
    }

    function performAnnotation() {
        const button = document.getElementById('startAnnotation');
        const progressBar = button.querySelector('.progress-bar');
        const buttonText = button.querySelector('.button-text');
        
        fetch('/start-annotation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            progressBar.style.width = '100%';
            if (data.success) {
                buttonText.innerHTML = '<i class="fas fa-check"></i> Annotation Complete!';
                setTimeout(() => {
                    window.location.href = '/annotation-verify';
                }, 1500);
            } else {
                alert('Error: ' + data.error);
                resetButton();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while starting the annotation process.');
            resetButton();
        });
    }

    function resetButton() {
        const button = document.getElementById('startAnnotation');
        const progressBar = button.querySelector('.progress-bar');
        const buttonText = button.querySelector('.button-text');
        
        button.disabled = false;
        button.classList.remove('processing');
        progressBar.style.width = '0%';
        buttonText.innerHTML = '<i class="fas fa-play"></i> Start Annotation Process';
    }
</script>

</body>
</html>